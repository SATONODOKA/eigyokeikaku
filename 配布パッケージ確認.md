# 営業計画管理システム - 配布パッケージ作成ガイド

**最終更新**: 2025年10月22日

## 📋 目次

1. [概要](#概要)
2. [前提条件](#前提条件)
3. [配布パッケージの作成手順](#配布パッケージの作成手順)
4. [トラブルシューティング](#トラブルシューティング)
5. [技術的詳細](#技術的詳細)
6. [今後の改善点](#今後の改善点)

---

## 概要

このプロジェクトは**完全オフライン動作可能な配布パッケージ**を作成します。

### 特徴

- ✅ **インターネット接続不要**
- ✅ **Node.jsインストール不要**（Portable版を同梱）
- ✅ **依存パッケージ同梱**（node_modules含む）
- ✅ **ワンクリック起動**（start.bat）
- ✅ **完全自己完結型**

---

## 前提条件

### 必須ツール

#### 7-Zip（圧縮高速化のため必須）

```powershell
winget install 7zip.7zip
```

**理由**: PowerShellのCompress-Archiveは以下の問題があります：
- **遅い**: node_modules（2万ファイル）の圧縮に数十分かかる
- **パス長制限**: Windowsの260文字制限でエラーになる
- **Unicode問題**: 日本語ファイル名が正しく処理されない

**7-Zipを使用すると**:
- 圧縮時間: 数十分 → **数秒**
- パス長制限: なし
- Unicode: 完全対応

### 開発環境

- Windows 10/11 (64bit)
- Node.js（開発用、配布物には不要）
- Git

---

## 配布パッケージの作成手順

### 1. クリーンアップ

```powershell
# 一時フォルダとZipファイルを削除
Remove-Item -Recurse -Force temp_package -ErrorAction SilentlyContinue
Remove-Item -Force eigyokeikaku_*.zip -ErrorAction SilentlyContinue
```

### 2. Zip作成実行

```cmd
create-zip.bat
```

**処理内容**:
1. 必須ファイルの存在確認（start.bat, nodejs-portable, node_modules）
2. temp_packageフォルダの作成
3. 必要なファイルのコピー
4. 7-Zipで圧縮（または PowerShell）
5. バージョン番号の自動インクリメント

### 3. 作成されるもの

- `eigyokeikaku_v{N}.zip`（約114MB）
  - Nはバージョン番号（version.txtで管理）

---

## トラブルシューティング

### 問題1: 圧縮が遅い

**原因**: PowerShellのCompress-Archiveを使用している

**解決策**:
```powershell
winget install 7zip.7zip
```

create-zip.batは自動的に7-Zipを優先使用します。

### 問題2: Zipにファイルが含まれない

**原因**: 
- start.batが存在しない
- nodejs-portableが存在しない
- node_modulesが存在しない

**解決策**:
```powershell
# Node.js Portableをダウンロード
.\download-nodejs-portable.bat

# 依存パッケージをインストール
npm install
```

### 問題3: 配布先で「Node.jsが見つかりません」エラー

**原因**: temp_package内の構造が間違っている

**確認方法**:
```powershell
# temp_packageの構造を確認
tree temp_package /F | more
```

**正しい構造**:
```
temp_package/
├── start.bat
├── nodejs-portable/
│   └── node.exe
├── node_modules/
├── app/
├── lib/
└── ...
```

---

## 技術的詳細

### ファイル構成

#### 削除した重複ファイル

以下のファイルは重複・不要のため削除されました：

1. **postcss.config.mjs** → postcss.config.js のみ使用
   - Tailwind CSS v3用の正しい設定
   
2. **next.config.js** → next.config.mjs のみ使用
   - ES Module形式の最新設定

3. **起動.bat** → start.bat にリネーム
   - Unicode（日本語）ファイル名の問題を回避

#### start.batの重要ポイント

```batch
REM 同梱Node.jsの絶対パス指定
set NODE_DIR=%CURRENT_DIR%nodejs-portable
set NODE_EXE=%NODE_DIR%\node.exe

REM 必須: node.exeの存在確認
if not exist "%NODE_EXE%" (
    echo Node.js実行ファイルが見つかりません
    exit /b 1
)

REM 重要: システムPATHを排除し、同梱版のみを使用
set PATH=%NODE_DIR%;%SystemRoot%\system32;%SystemRoot%

REM バージョン確認表示
"%NODE_EXE%" --version
```

**ポイント**:
- システムにNode.jsがインストールされていても、同梱版を優先
- PATH環境変数を完全に制御
- 絶対パスで実行ファイルを指定

#### .gitignoreの設定

```gitignore
# 配布パッケージ関連
temp_package/
eigyokeikaku_*.zip
version.txt
```

**理由**:
- temp_package: 一時フォルダ（2万ファイル）をGitに含めない
- eigyokeikaku_*.zip: バイナリファイルは除外
- version.txt: ローカル管理のみ

### create-zip.batの仕組み

```batch
REM バージョン管理
set /p VERSION=<version.txt 2>nul || set VERSION=1
set ZIPNAME=eigyokeikaku_v%VERSION%.zip

REM 7-Zipの自動検出と使用
where 7z >nul 2>&1
if %errorlevel% equ 0 (
    echo 7zipを使用して圧縮中...
    7z a -tzip "%ZIPNAME%" ".\%TEMPDIR%\*" >nul
) else (
    echo PowerShellで圧縮中（圧縮レベル: Fastest）...
    powershell -Command "Compress-Archive -Path '%TEMPDIR%\*' -DestinationPath '%ZIPNAME%' -CompressionLevel Fastest -Force"
)
```

---

## 配布物の使い方

### ユーザー側の手順

1. **eigyokeikaku_v{N}.zipを解凍**
2. **start.batをダブルクリック**
3. **完了！**

### 動作確認

```powershell
# Zip内容の確認
tar -tf eigyokeikaku_v2.zip | Select-String "start.bat|nodejs-portable/node.exe"

# 解凍して実行
Expand-Archive eigyokeikaku_v2.zip -DestinationPath test_dir
cd test_dir
.\start.bat
```

---

## 今後の改善点

### 検討事項

1. **圧縮レベルの最適化**
   - 現在: Fastest（速度優先）
   - 検討: Normal（サイズと速度のバランス）

2. **バージョン管理の自動化**
   - Git tagとの連携
   - CHANGELOGの自動生成

3. **配布先での自動更新機能**
   - 差分更新の実装
   - バージョンチェック機能

---

## 参考情報

### ファイルサイズ

- **元サイズ**: 約384MB
- **圧縮後**: 約114MB（7-Zip使用時）
- **ファイル数**: 約20,889ファイル

### 圧縮時間比較

| ツール | 時間 | サイズ |
|--------|------|--------|
| PowerShell (Optimal) | 数十分 | 115MB |
| PowerShell (Fastest) | 10-15分 | 120MB |
| 7-Zip | **数秒** | 114MB |

### node_modulesの構造

```
node_modules/
├── next/          # Next.jsフレームワーク
├── react/         # Reactライブラリ
├── tailwindcss/   # CSSフレームワーク
└── zustand/       # 状態管理
```

---

## 🚨 重要な注意事項

### やってはいけないこと

1. ❌ **temp_packageをGitに追加**
   - 2万ファイルあり、リポジトリが肥大化
   
2. ❌ **日本語ファイル名の使用**
   - Zip化時に文字化け・消失のリスク
   
3. ❌ **PowerShellのCompress-Archiveに頼る**
   - 7-Zipが圧倒的に高速・安定

4. ❌ **システムNode.jsへの依存**
   - 配布先の環境に依存しない設計が重要

### 必ず確認すること

1. ✅ **start.batの動作確認**
   - 同梱Node.jsが使われているか
   - バージョン表示が正しいか

2. ✅ **Zip内容の確認**
   ```powershell
   tar -tf eigyokeikaku_v{N}.zip | Select-String "start.bat"
   ```

3. ✅ **別環境でのテスト**
   - Node.js未インストール環境で動作確認
   - ネットワーク切断状態で動作確認

---

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. 7-Zipがインストールされているか
2. start.batが最新版か
3. nodejs-portableフォルダが存在するか
4. node_modulesフォルダが完全か

それでも解決しない場合は、create-zip.batを再実行してください。

---

**Happy Packaging! 🎉**
